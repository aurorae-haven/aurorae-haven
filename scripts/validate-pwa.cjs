#!/usr/bin/env node
/**
 * PWA Validation Script
 * Validates that all PWA requirements are met
 */

const fs = require('fs')
const path = require('path')

const publicDir = path.join(__dirname, '../public')
const viteConfigPath = process.env.VITE_CONFIG_PATH
  ? path.resolve(process.env.VITE_CONFIG_PATH)
  : path.join(__dirname, '../vite.config.js')

let errors = 0
let warnings = 0

function checkFile(filePath, description) {
  if (fs.existsSync(filePath)) {
    console.log(`‚úÖ ${description}`)
    return true
  } else {
    console.error(`‚ùå ${description} - File not found: ${filePath}`)
    errors++
    return false
  }
}

function validateJSON(filePath, description) {
  try {
    const content = fs.readFileSync(filePath, 'utf8')
    JSON.parse(content)
    console.log(`‚úÖ ${description} - Valid JSON`)
    return true
  } catch (e) {
    console.error(`‚ùå ${description} - Invalid JSON: ${e.message}`)
    errors++
    return false
  }
}

function validateManifest() {
  const manifestPath = path.join(publicDir, 'manifest.json')
  if (!checkFile(manifestPath, 'Manifest file exists')) return
  if (!validateJSON(manifestPath, 'Manifest JSON')) return

  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'))

  // Check required fields
  const requiredFields = ['name', 'short_name', 'start_url', 'display', 'icons']
  requiredFields.forEach((field) => {
    if (manifest[field]) {
      console.log(`‚úÖ Manifest has '${field}' field`)
    } else {
      console.error(`‚ùå Manifest missing required field: '${field}'`)
      errors++
    }
  })

  // Check icons
  if (Array.isArray(manifest.icons) && manifest.icons.length > 0) {
    console.log(`‚úÖ Manifest has ${manifest.icons.length} icon(s)`)
  } else {
    console.error('‚ùå Manifest has no icons')
    errors++
  }
}

function validateServiceWorker() {
  // Service worker is now generated by VitePWA plugin during build
  // Check for the VitePWA configuration in vite.config.js
  if (!checkFile(viteConfigPath, 'vite.config.js exists')) return

  const content = fs.readFileSync(viteConfigPath, 'utf8')

  // Check for VitePWA plugin configuration
  if (content.includes('VitePWA')) {
    console.log('‚úÖ VitePWA plugin configured')
  } else {
    console.error('‚ùå VitePWA plugin not configured')
    errors++
    return
  }

  // Check for navigation fallback configuration
  if (content.includes('navigateFallback')) {
    console.log('‚úÖ Navigation fallback configured for SPA routing')
  } else {
    console.warn('‚ö†Ô∏è  Navigation fallback not explicitly configured')
    warnings++
  }

  // Check for workbox configuration
  if (content.includes('workbox:')) {
    console.log('‚úÖ Workbox configuration present')
  } else {
    console.warn('‚ö†Ô∏è  Workbox configuration not found')
    warnings++
  }
}

function validateIcons() {
  const icons = ['icon-192x192.svg', 'icon-512x512.svg']
  icons.forEach((icon) => {
    checkFile(path.join(publicDir, icon), `Icon file: ${icon}`)
  })
}

function validateIndexHTML() {
  const indexPath = path.join(publicDir, 'index.html')
  if (!checkFile(indexPath, 'index.html exists')) return

  const content = fs.readFileSync(indexPath, 'utf8')

  // Check for manifest link
  // Note: VitePWA plugin automatically injects the manifest link during build
  if (content.includes('rel="manifest"')) {
    console.log('‚úÖ index.html links to manifest')
  } else {
    console.log(
      '‚ÑπÔ∏è  Manifest link is injected during build by VitePWA plugin'
    )
  }

  // Check for theme-color
  if (content.includes('name="theme-color"')) {
    console.log('‚úÖ index.html has theme-color meta tag')
  } else {
    console.warn('‚ö†Ô∏è  index.html missing theme-color meta tag')
    warnings++
  }
}

function validateServiceWorkerRegistration() {
  // Service worker registration is now handled automatically by VitePWA plugin
  // The plugin injects the registration script during build
  const content = fs.readFileSync(viteConfigPath, 'utf8')

  if (content.includes('registerType:')) {
    console.log('‚úÖ Service worker auto-registration configured via VitePWA')
  } else {
    console.warn(
      '‚ö†Ô∏è  Service worker registration type not explicitly configured'
    )
    warnings++
  }

  // Note: The actual registration script (registerSW.js) is generated during build
  console.log(
    '‚ÑπÔ∏è  Service worker registration script is generated during build by VitePWA'
  )
}

console.log('üîç Validating PWA Implementation...\n')

console.log('üìÑ Manifest Validation:')
validateManifest()

console.log('\n‚öôÔ∏è  Service Worker Validation:')
validateServiceWorker()

console.log('\nüé® Icons Validation:')
validateIcons()

console.log('\nüìù HTML Validation:')
validateIndexHTML()

console.log('\nüîß Service Worker Registration Validation:')
validateServiceWorkerRegistration()

console.log('\n' + '='.repeat(50))
if (errors === 0 && warnings === 0) {
  console.log('‚úÖ All PWA requirements met!')
  process.exit(0)
} else {
  console.log(`Results: ${errors} error(s), ${warnings} warning(s)`)
  if (errors > 0) {
    console.log('‚ùå PWA validation failed')
    process.exit(1)
  } else {
    console.log('‚ö†Ô∏è  PWA validation passed with warnings')
    process.exit(0)
  }
}
